(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[664],{3850:function(e,l,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/monitor/summary-by-establishment",function(){return s(3015)}])},3015:function(e,l,s){"use strict";s.r(l),s.d(l,{__N_SSP:function(){return k},default:function(){return M}});var a=s(2322),t=s(2784),i=s(6310),n=s(7989),r=s(2174),c=s(857),o=s(261),d=s(6391),u=s(6068),m=s(647),h=s(6405),p=s(7871),x=s(7716),f=s(5803),j=s(7936);let g=["drawing","elevation"];var Map=e=>{let{establishments:l,selectedEstablishment:s,setSelectedEstablishment:i}=e,n=(0,r.useTranslations)(),[c,o]=(0,t.useState)(null),[u,m]=(0,t.useState)(null),h=(0,t.useRef)(null==s?void 0:s.id),{isLoaded:v}=(0,p.Db)({googleMapsApiKey:f.O.NEXT_PUBLIC_MAPS_API_KEY,libraries:g}),handleSelectionChange=e=>{if(h.current=e,"allEstablishments"===e)return i(void 0);let s=l.find(e=>e.id===h.current);i(s)},handleMarkerClick=(e,l,s,a)=>{m({id:e,name:l,latitude:s,longitude:a,clicked:!0}),handleSelectionChange(e)},getMarkers=()=>s?[s]:l;return(0,t.useEffect)(()=>{if(c){let e=new window.google.maps.LatLngBounds;getMarkers().map(l=>{let{latitude:s,longitude:a}=l;e.extend({lat:s,lng:a})}),c.fitBounds(e,40)}},[c,l,s]),(0,a.jsxs)(d.Zb,{className:"flex max-h-[800px] flex-grow flex-col gap-6 p-6",children:[(0,a.jsxs)(j.Ph,{value:h.current,onValueChange:handleSelectionChange,children:[(0,a.jsx)(j.i4,{className:"h-[40px] w-full",children:(0,a.jsx)(j.ki,{placeholder:n("map.allEstablishments")})}),(0,a.jsxs)(j.Bw,{children:[(0,a.jsx)(j.Ql,{value:"allEstablishments",children:n("map.allEstablishments")}),l.map((e,l)=>{let{name:s,id:t}=e;return(0,a.jsx)(j.Ql,{value:t,children:s},l)})]})]}),(0,a.jsx)("div",{className:"flex h-full w-full items-center justify-center",children:v?(0,a.jsx)(p.b6,{mapContainerClassName:"h-full w-full min-h-[200px]",onLoad:e=>{e.setOptions({maxZoom:10}),o(e)},children:getMarkers().map((e,l)=>{let{id:s,name:t,latitude:i,longitude:n}=e;return(0,a.jsx)(p.jC,{onMouseOver:()=>!(null==u?void 0:u.clicked)&&m({id:s,name:t,latitude:i,longitude:n,clicked:!1}),onMouseOut:()=>!(null==u?void 0:u.clicked)&&m(null),onClick:()=>handleMarkerClick(s,t,i,n),position:{lat:i,lng:n},icon:{url:"/icons/location-pin.svg"},children:(null==u?void 0:u.id)===s&&(0,a.jsx)(p.kp,{onCloseClick:()=>{m(null),handleSelectionChange("allEstablishments")},position:{lat:i,lng:n},children:(0,a.jsx)("p",{children:t})})},l)})}):(0,a.jsx)(x.Z,{className:"animate-spin",size:20})})]})},v=s(3411),b=s(1267),N=s(2428),molecules_MetricsCard=e=>{let{area:l,crops:s,latitude:t,longitude:i,soilType:n,ph:c,organicMaterial:o,nitrogen:u,phosphorus:m}=e,h=(0,r.useTranslations)();return(0,a.jsxs)(d.Zb,{className:"flex flex-col justify-between gap-10 p-4 font-secondary lg:flex-row",children:[(0,a.jsxs)("div",{className:"min-w-[200px] lg:w-1/2 lg:max-w-[400px]",children:[(0,a.jsx)(b.Z,{className:"mb-4 text-lg",children:h("cards.metricsCard.landMetrics")}),(0,a.jsxs)("div",{className:"w-full text-sm 2xl:text-base",children:[(0,a.jsxs)("div",{className:"mb-1 flex border-b border-muted font-bold",children:[(0,a.jsx)("p",{className:"w-1/2",children:h("cards.metricsCard.parameter")}),(0,a.jsx)("p",{className:"w-1/2",children:h("cards.metricsCard.value")})]}),(0,a.jsxs)("div",{className:"flex pt-2",children:[(0,a.jsx)("p",{className:"w-1/2",children:h("cards.metricsCard.totalArea")}),(0,a.jsx)("p",{className:"w-1/2 whitespace-nowrap",children:(0,a.jsxs)(N.x,{children:[l?"".concat((0,v.N)(l)," ha"):"-",(0,a.jsx)(N.B,{orientation:"horizontal"})]})})]}),s.sort((e,l)=>l.cropArea-e.cropArea).slice(0,3).map(e=>(0,a.jsxs)("div",{className:"flex pt-2 text-sm text-gray/600",children:[(0,a.jsx)("p",{className:"w-1/2",children:(0,a.jsx)("li",{children:e.cropName})}),(0,a.jsx)("p",{className:"w-1/2 whitespace-nowrap",children:(0,a.jsxs)(N.x,{children:[(0,v.N)(e.cropArea)," ha",(0,a.jsx)(N.B,{orientation:"horizontal"})]})})]},e.cropName)),(0,a.jsxs)("div",{className:"flex pt-2",children:[(0,a.jsx)("p",{className:"w-1/2",children:h("cards.metricsCard.latitude")}),(0,a.jsx)("p",{className:"w-1/2 whitespace-nowrap",children:(0,a.jsxs)(N.x,{children:[null!=t?t:"-",(0,a.jsx)(N.B,{orientation:"horizontal"})]})})]}),(0,a.jsxs)("div",{className:"flex pt-2",children:[(0,a.jsx)("p",{className:"w-1/2",children:h("cards.metricsCard.longitude")}),(0,a.jsx)("p",{className:"w-1/2 whitespace-nowrap",children:(0,a.jsxs)(N.x,{children:[null!=i?i:"-",(0,a.jsx)(N.B,{orientation:"horizontal"})]})})]})]})]}),(0,a.jsxs)("div",{className:"min-w-[200px] lg:w-1/2 lg:max-w-[400px]",children:[(0,a.jsx)(b.Z,{className:"mb-4 text-lg",children:h("cards.metricsCard.environmentalMetrics")}),(0,a.jsxs)("div",{className:"w-full text-sm 2xl:text-base",children:[(0,a.jsxs)("div",{className:"mb-1 flex border-b border-muted font-bold",children:[(0,a.jsx)("p",{className:"w-1/2",children:h("cards.metricsCard.parameter")}),(0,a.jsx)("p",{className:"w-1/2",children:h("cards.metricsCard.value")})]}),(0,a.jsxs)("div",{className:"flex pt-2",children:[(0,a.jsx)("p",{className:"w-1/2",children:h("cards.metricsCard.soilType")}),(0,a.jsx)("p",{className:"w-1/2 whitespace-nowrap",children:(0,a.jsxs)(N.x,{children:[null!=n?n:"-",(0,a.jsx)(N.B,{orientation:"horizontal"})]})})]}),(0,a.jsxs)("div",{className:"flex pt-2",children:[(0,a.jsx)("p",{className:"w-1/2",children:h("cards.metricsCard.soilPh")}),(0,a.jsx)("p",{className:"w-1/2",children:(0,a.jsx)(N.x,{children:c?(0,v.N)(c):"-"})})]}),(0,a.jsxs)("div",{className:"flex pt-2",children:[(0,a.jsx)("p",{className:"w-1/2",children:h("cards.metricsCard.organicMaterial")}),(0,a.jsx)("p",{className:"w-1/2",children:(0,a.jsx)(N.x,{children:o?"".concat((0,v.N)(o)," %"):"-"})})]}),(0,a.jsxs)("div",{className:"flex pt-2",children:[(0,a.jsx)("p",{className:"w-1/2",children:h("cards.metricsCard.nitrogen")}),(0,a.jsx)("p",{className:"w-1/2",children:(0,a.jsx)(N.x,{children:u?"".concat((0,v.N)(u)," %"):"-"})})]}),(0,a.jsxs)("div",{className:"flex pt-2",children:[(0,a.jsx)("p",{className:"w-1/2",children:h("cards.metricsCard.phosphorus")}),(0,a.jsx)("p",{className:"w-1/2",children:(0,a.jsx)(N.x,{children:m?"".concat((0,v.N)(m)," ppm"):"-"})})]})]})]})]})},w=s(486),y=s(3230),C=s(7687),hooks_useSummaryByEstablishment=e=>{let{category:l,selectedEstablishment:s}=e,{isLoading:a,data:i}=C.h.monitor.summaryByEstablishment.useQuery({category:l}),n=null==i?void 0:i.map(e=>{let l=e.productCampaigns.map(e=>({id:e.product.id,name:e.product.name,area:e.area})),s=e.productCampaigns.flatMap(e=>e.productKpis.map(e=>({kpiId:e.kpi.id,name:e.kpi.name,category:e.kpi.category,unit:e.kpi.unit,key:e.kpi.key,scopes:e.scopes?[{scope1:e.scopes.scope1,scope2:e.scopes.scope2,scope3:e.scopes.scope3}]:[],currentValue:e.totalValue})));return{establishmentId:e.establishmentId,establishment:{area:e.establishment.area,name:e.establishment.name,latitude:e.establishment.latitude,longitude:e.establishment.longitude,soilType:e.establishment.soilType,soilPH:e.establishment.soilPh,organicMaterial:e.establishment.organicMaterial,nitrogen:e.establishment.nitrogen,phosphorous:e.establishment.phosphorus},products:l,kpis:s}}),calculateKpis=e=>{let l=[];return(null!=e?e:[]).forEach(e=>{let{kpis:s}=e;s.forEach(e=>{let s=l.find(l=>l.id===e.kpiId);s?s.value+=e.currentValue:l.push({id:e.kpiId,name:e.name,value:e.currentValue,unit:e.unit,key:e.key})})}),l},r=["scope1","scope2","scope3"],calculateScopes=e=>{let l=s?null==n?void 0:n.filter(e=>e.establishmentId===s.id):n;return r.reduce((s,a)=>(s[a]=e?(null!=l?l:[]).reduce((e,l)=>{let{kpis:s}=l;return s.reduce((e,l)=>l.scopes[0]?e+l.scopes[0][a]:e,0)+e},0):0,s),{})},c={},o=n;s&&(o=null==n?void 0:n.filter(e=>e.establishmentId===(null==s?void 0:s.id))),null==o||o.forEach(e=>{let{products:l}=e;l.forEach(e=>{let l=c[e.id];l?l.area+=e.area:c[e.id]={name:e.name,area:e.area}})});let d=Object.values(c).reduce((e,l)=>e+l.area,0),u=(()=>{var e;let s=calculateKpis(n);return{kpiValues:s,scopes:"ClimateChange"===l?calculateScopes(null===(e=s[0])||void 0===e?void 0:e.value):void 0,area:(null!=n?n:[]).reduce((e,l)=>{let{establishment:s}=l;return s.area?e+s.area:e},0),latitude:null,longitude:null,soilType:(null!=n?n:[]).map(e=>{let{establishment:l}=e;return l.soilType}).filter((e,l,s)=>s.indexOf(e)===l).join(", "),soilPH:null,organicMaterial:null,nitrogen:null,phosphorous:null,products:Object.values(c),totalHarvestedArea:d}})(),[m,h]=(0,t.useState)();return(0,t.useEffect)(()=>{i&&!m&&h(u)},[i]),(0,t.useEffect)(()=>{if(s){let a=(null!=n?n:[]).find(e=>{let{establishmentId:l}=e;return l===s.id});if(a){var e;let{products:s,establishment:t}=a,i=[];i.push(a);let n=calculateKpis(i);h({kpiValues:n,scopes:"ClimateChange"===l?calculateScopes(null===(e=n[0])||void 0===e?void 0:e.value):void 0,products:s,area:t.area,latitude:t.latitude,longitude:t.longitude,soilType:t.soilType,soilPH:t.soilPH,organicMaterial:t.organicMaterial,nitrogen:t.nitrogen,phosphorous:t.phosphorous,totalHarvestedArea:d})}}else h(u)},[s]),{filteredData:m,toDMS:(e,l)=>{if(null===e)return"-";let s=Math.abs(e),a=Math.floor(s),t=(s-a)*60,i=Math.floor(t),n=Math.floor((t-i)*60),r="";return r=l?e>=0?"E":"W":e>=0?"N":"S","".concat(a,"\xb0").concat(i,"'").concat(n,'"').concat(r)},pageDataLoading:a,establishmentsCampaign:n,showOngoingCampaign:()=>{if(s){let e=null==i?void 0:i.find(e=>e.establishmentId===s.id),l=null==e?void 0:e.productCampaigns.find(e=>!e.endDate);return!!l}let e=null==i?void 0:i.flatMap(e=>e.productCampaigns),l=null==e?void 0:e.find(e=>!e.endDate);return!!l},noFinishedCampaigns:()=>{if(s){let e=null==i?void 0:i.find(e=>e.establishmentId===s.id),l=null==e?void 0:e.productCampaigns.find(e=>!!e.endDate);return!l}let e=null==i?void 0:i.flatMap(e=>e.productCampaigns),l=null==e?void 0:e.find(e=>!!e.endDate);return!l}}},E=s(6229);let Shimmer=()=>(0,a.jsxs)("div",{className:"flex h-full flex-col gap-3 lg:flex-row",children:[(0,a.jsxs)("div",{className:"flex flex-col gap-3 lg:w-[60%]",children:[(0,a.jsx)(d.Zb,{className:"w-full p-4",children:(0,a.jsx)(u.O,{className:"h-[100px]"})}),(0,a.jsx)(d.Zb,{className:"w-full p-4",children:(0,a.jsx)(u.O,{className:"h-[100px]"})}),(0,a.jsxs)(d.Zb,{className:"flex flex-col justify-between gap-10 p-4 font-secondary sm:flex-row",children:[(0,a.jsxs)("div",{className:"sm:w-1/2",children:[(0,a.jsx)(u.O,{className:"mb-4 h-[25px]"}),(0,a.jsx)(u.O,{className:"h-[200px]"})]}),(0,a.jsxs)("div",{className:"sm:w-1/2",children:[(0,a.jsx)(u.O,{className:"mb-4 h-[25px]"}),(0,a.jsx)(u.O,{className:"h-[200px]"})]})]})]}),(0,a.jsxs)(d.Zb,{className:"flex flex-col gap-4 p-4 lg:w-[40%]",children:[(0,a.jsx)(u.O,{className:"h-[40px] w-full"}),(0,a.jsx)(u.O,{className:"h-full min-h-[250px] w-full"})]})]});var monitor_SummaryByEstablishment=e=>{var l,s,t,i,n,u,p,x,f,j;let{selectedSwitchTab:g,category:v,showScopes:b=!1,selectedEstablishment:N,setSelectedEstablishment:C}=e,S=(0,r.useLocale)(),k=(0,r.useTranslations)(),{filteredData:M,toDMS:_,pageDataLoading:B,establishmentsCampaign:T,showOngoingCampaign:P,noFinishedCampaigns:O}=hooks_useSummaryByEstablishment({category:v,selectedEstablishment:N});return!B&&T&&M?O()?(0,a.jsx)("div",{className:"h-[calc(100vh_-_260px)] lg:h-[calc(100vh_-_210px)]",children:(0,a.jsx)(y.Z,{})}):(0,a.jsxs)("div",{className:"flex h-full flex-col gap-3 lg:flex-row",children:[(0,a.jsxs)("div",{className:"flex w-full flex-col gap-3 lg:w-[60%]",children:[(0,a.jsx)("div",{className:(0,E.cn)("grid gap-1",M.kpiValues.length>1&&"lg:grid-cols-2"),children:M.kpiValues.filter(e=>"WaterProductivity"!==e.key).map(e=>{let{name:l,value:s,id:t,unit:i,key:n}=e;return(0,a.jsx)(w.Z,{amount:"absolute"===g||(0,o.JU)(n)?s:s/M.totalHarvestedArea,unit:"absolute"===g||(0,o.JU)(n)?i:"".concat(i," / ha "),enableFooter:!1,title:(0,c.i)(l,S)},t)})}),b&&(0,a.jsx)(d.Zb,{className:"w-full p-4",children:(0,a.jsx)(m.Z,{items:[{name:"S1",value:null!==(i=null==M?void 0:null===(l=M.scopes)||void 0===l?void 0:l.scope1)&&void 0!==i?i:0},{name:"S2",value:null!==(n=null==M?void 0:null===(s=M.scopes)||void 0===s?void 0:s.scope2)&&void 0!==n?n:0},{name:"S3",value:null!==(u=null==M?void 0:null===(t=M.scopes)||void 0===t?void 0:t.scope3)&&void 0!==u?u:0}],showInformation:!0})}),(0,a.jsx)(molecules_MetricsCard,{area:M.area,crops:M.products.map(e=>({cropName:(0,c.i)(e.name,S),cropArea:e.area})),latitude:_(M.latitude,!1),longitude:_(M.longitude,!0),soilType:M.soilType,ph:null!==(p=M.soilPH)&&void 0!==p?p:void 0,organicMaterial:null!==(x=M.organicMaterial)&&void 0!==x?x:void 0,nitrogen:null!==(f=M.nitrogen)&&void 0!==f?f:void 0,phosphorus:null!==(j=M.phosphorous)&&void 0!==j?j:void 0})]}),(0,a.jsxs)("div",{className:"flex w-full flex-col gap-2 lg:w-[40%]",children:[(0,a.jsx)(Map,{selectedEstablishment:N,setSelectedEstablishment:C,establishments:T.map(e=>{let{establishment:l,establishmentId:s}=e;return{id:s,name:l.name,latitude:l.latitude,longitude:l.longitude}})}),P()&&(0,a.jsx)(h.Z,{text:k("monitor.summaryByProduct.ongoingCampaignMessage")})]})]}):(0,a.jsx)(Shimmer,{})},S=s(3197);let SummaryByEstablishmentPage=()=>{let[e,l]=(0,t.useState)("absolute"),[s,r]=(0,t.useState)("climateChange"),[c,o]=(0,t.useState)();return s&&(0,a.jsx)(n.Z,{switchTabs:(0,a.jsx)(i.Z,{key1:"intensity",key2:"absolute",setSelected:l,defaultValue:"absolute"}),className:"w-full",selectedTab:s,setSelectedTab:r,tabs:[{key:"climateChange",content:(0,a.jsx)(monitor_SummaryByEstablishment,{selectedSwitchTab:e,category:"ClimateChange",showScopes:!0,selectedEstablishment:c,setSelectedEstablishment:o})},{key:"ecosystemQuality",content:(0,a.jsx)(monitor_SummaryByEstablishment,{selectedSwitchTab:e,category:"EcosystemQuality",selectedEstablishment:c,setSelectedEstablishment:o})},{key:"humanHealth",content:(0,a.jsx)(monitor_SummaryByEstablishment,{selectedSwitchTab:e,category:"HumanHealth",selectedEstablishment:c,setSelectedEstablishment:o})},{key:"resourcesExhaustion",content:(0,a.jsx)(monitor_SummaryByEstablishment,{selectedSwitchTab:e,category:"ResourcesExhaustion",selectedEstablishment:c,setSelectedEstablishment:o})}]})};SummaryByEstablishmentPage.getLayout=e=>(0,a.jsx)(S.Z,{titleKey:"summaryByEstablishment",children:e});var k=!0,M=SummaryByEstablishmentPage}},function(e){e.O(0,[235,917,525,461,898,713,872,688,612,512,535,372,641,624,774,888,179],function(){return e(e.s=3850)}),_N_E=e.O()}]);